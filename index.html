<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥n Audio - Dashboard General</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-sidebar: #020617;
      --bg-card: #0f172a;
      --bg-card-soft: #111827;
      --accent: #ef4444;
      --accent-soft: #fecaca;
      --accent-warn: #f97316;
      --accent-danger: #ef4444;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --radius-lg: 14px;
      --radius-xl: 18px;
      --shadow-soft: 0 14px 30px rgba(0,0,0,.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #1f2937, #020617 45%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    body.light-theme {
      --bg: #f3f4f6;
      --bg-sidebar: #000000;
      --bg-card: #ffffff;
      --bg-card-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #d1d5db;
      background: #f3f4f6;
      color: var(--text-main);
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, var(--bg-sidebar), var(--bg-sidebar) 40%, var(--bg-sidebar));
      border-right: 1px solid var(--border-soft);
      padding: 20px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fecaca, #b91c1c);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: #fef2f2;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo-title {
      font-weight: 800;
      font-size: 1.05rem;
      letter-spacing: .03em;
    }

    .logo-title span {
      display: inline-block;
    }

    .logo-title-gestion {
      color: #f97316;
    }

    .logo-title-audio {
      color: #38bdf8;
      margin-left: 2px;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .module-badge {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: .78rem;
      padding: 6px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, #ef4444, #f97316);
      color: #fef2f2;
      border: 1px solid #b91c1c;
    }

    .module-badge-icon {
      font-size: .9rem;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: var(--text-muted);
    }

    /* Main */
    .main {
      flex: 1;
      padding: 18px 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid #ef4444;
      font-size: .78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #ef4444;
      color: #fef2f2;
      box-shadow: none;
      transition: background .15s ease, transform .08s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      background: #dc2626;
    }

    .btn-cta {
      font-weight: 600;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    body.light-theme .btn {
      background: #ef4444;
      color: #fef2f2;
      border-color: #ef4444;
    }

    .filters-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      font-size: .8rem;
      margin-top: 6px;
    }

    .select {
      background: rgba(15,23,42,.95);
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      outline: none;
      font-size: .8rem;
    }

    body.light-theme .select {
      background: #ffffff;
      color: #111827;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .section-header h2 {
      font-size: 1.08rem;
      font-weight: 600;
    }

    .section-header span.sub {
      font-size: .78rem;
      color: var(--text-muted);
    }

    /* KPI pills */
    .kpi-row {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 2px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .kpi-row::-webkit-scrollbar {
      height: 4px;
    }
    .kpi-row::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.7);
      border-radius: 999px;
    }

    .kpi-pill {
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: .76rem;
      cursor: default;
      border: 1px solid #b91c1c;
      background: #ef4444;
      color: #fef2f2;
      box-shadow: 0 4px 10px rgba(239,68,68,0.45);
      min-width: 150px;
      flex-shrink: 0;
    }

    body.light-theme .kpi-pill {
      background: #ef4444;
      color: #fef2f2;
      box-shadow: 0 4px 10px rgba(239,68,68,0.35);
    }

    .kpi-main-block {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .kpi-label {
      opacity: .9;
    }

    .kpi-value {
      font-weight: 700;
      font-size: .8rem;
    }

    .kpi-status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(248,250,252,0.9);
      background: rgba(15,23,42,0.28);
    }

    .kpi-status-icon {
      font-size: .7rem;
    }

    .kpi-status.optimo {
      background: rgba(22,163,74,0.15);
    }

    .kpi-status.muybien {
      background: rgba(234,179,8,0.15);
    }

    .kpi-status.mejorable {
      background: rgba(220,38,38,0.2);
    }

    /* Cards y gr√°ficos */
    .card {
      background: radial-gradient(circle at top left, var(--bg-card-soft), #020617 55%);
      border-radius: var(--radius-xl);
      padding: 14px 14px 12px;
      border: 1px solid rgba(15,23,42,.9);
      box-shadow: var(--shadow-soft);
      position: relative;
    }

    body.light-theme .card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(15,23,42,.12);
    }

    .card h3 {
      font-size: .9rem;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: .76rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .card-badge {
      position: absolute;
      top: 12px;
      right: 14px;
      font-size: .68rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(148,163,184,0.22);
      color: var(--text-muted);
    }

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 16px;
      align-items: stretch;
      margin-top: 8px;
    }

    .grid-bottom {
      margin-top: 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
      gap: 16px;
      align-items: stretch;
    }

    .chart-container {
      position: relative;
      height: 230px;
      width: 100%;
    }

    .chart-container.tall {
      height: 260px;
    }

    /* Criterios procesos */
    .criteria-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: .76rem;
      max-height: 210px;
      overflow-y: auto;
    }

    .criteria-list::-webkit-scrollbar {
      width: 4px;
    }
    .criteria-list::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.7);
      border-radius: 999px;
    }

    .criteria-item {
      display: flex;
      gap: 6px;
      align-items: flex-start;
    }

    .criteria-index {
      min-width: 1.5rem;
      height: 1.4rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      flex-shrink: 0;
    }

    body.light-theme .criteria-index {
      background: #111827;
      color: #f9fafb;
    }

    .criteria-text {
      flex: 1;
      color: var(--text-main);
      opacity: .9;
    }

    body.light-theme .criteria-text {
      color: #111827;
    }

    .criteria-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .7rem;
      color: var(--text-muted);
    }

    .criteria-btn {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148,163,184,0.9);
      background: transparent;
      color: inherit;
      font-size: .72rem;
      cursor: pointer;
    }

    .criteria-btn:hover {
      background: rgba(148,163,184,0.12);
    }

    /* Informe de visita */
    .visit-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.6fr);
      gap: 12px;
      margin-top: 4px;
      font-size: .78rem;
    }

    .visit-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-bottom: 6px;
    }

    .visit-label {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .visit-input,
    .visit-select,
    .visit-textarea {
      background: #020617;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 5px 8px;
      font-size: .78rem;
      color: var(--text-main);
      outline: none;
    }

    .visit-textarea {
      min-height: 82px;
      resize: vertical;
    }

    body.light-theme .visit-input,
    body.light-theme .visit-select,
    body.light-theme .visit-textarea {
      background: #f9fafb;
      color: #111827;
      border-color: #d1d5db;
    }

    .visit-meta-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }

    .visit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .visit-tag {
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.6);
    }

    body.light-theme .visit-tag {
      background: #f3f4f6;
    }

    /* Toasts */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.6);
      font-size: .8rem;
      color: var(--text-main);
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      opacity: 1;
      transition: opacity .3s ease, transform .3s ease;
      transform: translateY(0);
      z-index: 9999;
    }

    .toast.hide {
      opacity: 0;
      transform: translateY(6px);
    }

    /* Print styles */
    @media print {
      @page {
        size: A4 portrait;
        margin: 10mm;
      }
      body {
        background: #ffffff !important;
      }
      .sidebar {
        display: none !important;
      }
      .topbar .btn,
      .filters-row {
        display: none !important;
      }
      .main {
        padding: 0 !important;
      }
      .card {
        box-shadow: none !important;
        margin-bottom: 6px;
      }
    }

    /* Responsivo */
    @media (max-width: 960px) {
      .sidebar {
        display: none;
      }
      body {
        display: block;
      }
      .main {
        padding: 14px;
      }
      .grid-main,
      .grid-bottom,
      .visit-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üéß</div>
      <div class="logo-text">
        <div class="logo-title">
          <span class="logo-title-gestion">Gesti√≥n</span><span class="logo-title-audio"> Audio</span>
        </div>
        <span class="logo-subtitle">Dashboard general de procesos y KPIs</span>
      </div>
    </div>

    <div class="module-badge">
      <span class="module-badge-icon">üìä</span>
      <span>Dashboard general</span>
    </div>

    <div class="sidebar-footer">
      <p>Versi√≥n demo ¬∑ Datos ficticios</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <button class="btn" id="btnToggleTheme">
        <span class="icon">‚òÄÔ∏è</span> Modo claro
      </button>
      <button class="btn" id="btnSaveView">
        <span class="icon">üíæ</span> Guardar vista
      </button>
      <button class="btn" id="btnPrint">
        <span class="icon">üñ®Ô∏è</span> Imprimir
      </button>
      <button class="btn" id="btnExportHtml">
        <span class="icon">‚¨áÔ∏è</span> Exportar HTML
      </button>
      <button class="btn btn-cta" id="btnSyncCloud">
        <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
      </button>
    </div>

    <!-- Filtros -->
    <div class="filters-row">
      <select class="select" id="selectCentro">
        <option value="todos">Centro: Todos</option>
        <option value="reina-mercedes">Madrid ¬∑ Reina Mercedes</option>
        <option value="tetuan">Madrid ¬∑ Tetu√°n</option>
        <option value="nervion">Sevilla ¬∑ Nervi√≥n</option>
        <option value="gran-via">Bilbao ¬∑ Gran V√≠a</option>
      </select>
      <select class="select" id="selectDelegado">
        <option value="todos">Delegado: Todos</option>
        <option value="blanca">Blanca</option>
        <option value="cecilia">Cecilia</option>
        <option value="daniel">Daniel</option>
        <option value="eneritz">Eneritz</option>
        <option value="luis">Luis</option>
      </select>
    </div>

    <!-- Resumen general -->
    <div>
      <div class="section-header">
        <h2>Resumen general KPIs</h2>
        <span class="sub" id="resumenSub">
          Visi√≥n r√°pida de procesos, HIT, primeros auxilios, conversiones y formaciones
        </span>
      </div>

      <!-- KPIs -->
      <section class="kpi-row">
        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">Procesos aplicados</span>
            <span class="kpi-value" id="kpiProcesos">92%</span>
          </div>
          <span class="kpi-status" title="">
            <span class="kpi-status-icon"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">HIT global</span>
            <span class="kpi-value" id="kpiHit">100%</span>
          </div>
          <span class="kpi-status" title="">
            <span class="kpi-status-icon"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">Primeros auxilios</span>
            <span class="kpi-value" id="kpiPrimerosAuxilios">63%</span>
          </div>
          <span class="kpi-status" title="">
            <span class="kpi-status-icon"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="conversion">
          <div class="kpi-main-block">
            <span class="kpi-label">Conv. a prueba</span>
            <span class="kpi-value" id="kpiConvPrueba">72%</span>
          </div>
          <span class="kpi-status" title="">
            <span class="kpi-status-icon"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="conversion">
          <div class="kpi-main-block">
            <span class="kpi-label">Conv. a venta</span>
            <span class="kpi-value" id="kpiConvVenta">81%</span>
          </div>
          <span class="kpi-status" title="">
            <span class="kpi-status-icon"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">Formaciones</span>
            <span class="kpi-value" id="kpiFormaciones">88%</span>
          </div>
          <span class="kpi-status" title="">
            <span class="kpi-status-icon"></span>
          </span>
        </div>
      </section>
    </div>

    <!-- Gr√°ficos principales -->
    <section class="grid-main">
      <!-- Evoluci√≥n mensual -->
      <article class="card">
        <span class="card-badge">% demo</span>
        <h3>Evoluci√≥n mensual de procesos y resultados</h3>
        <p class="card-sub">
          Barras de % procesos aplicados y curvas de HIT, conversi√≥n a prueba y conversi√≥n a venta
        </p>
        <div class="chart-container">
          <canvas id="chartEvolucion"></canvas>
        </div>
      </article>

      <!-- Estado de visitas -->
      <article class="card">
        <span class="card-badge">% demo</span>
        <h3>Estado de visitas</h3>
        <p class="card-sub">
          Distribuci√≥n de visitas realizadas, pendientes y anuladas ¬∑ Ene ‚Äì Dic
        </p>
        <div class="chart-container">
          <canvas id="chartVisitas"></canvas>
        </div>
      </article>

      <!-- √Årea de mejora -->
      <article class="card">
        <span class="card-badge">% demo</span>
        <h3>√Årea de mejora de procesos</h3>
        <p class="card-sub">
          Top 10 criterios con mayor porcentaje de procesos no aplicados
        </p>
        <div class="chart-container tall">
          <canvas id="chartAreaMejora"></canvas>
        </div>
      </article>

      <!-- Ranking delegados -->
      <article class="card">
        <span class="card-badge">% demo</span>
        <h3>Ranking por delegados ¬∑ √≠ndice global</h3>
        <p class="card-sub">
          √çndice global promedio de todos sus centros evaluados ¬∑ Top 5 delegados
        </p>
        <div class="chart-container tall">
          <canvas id="chartDelegados"></canvas>
        </div>
      </article>
    </section>

    <!-- Bloque inferior alineado: indicadores + criterios -->
    <section class="grid-bottom">
      <!-- % Procesos, HIT y ARR -->
      <article class="card">
        <span class="card-badge">% demo</span>
        <h3>Indicadores globales ¬∑ Procesos, HIT y ARR</h3>
        <p class="card-sub">
          % global de procesos aplicados, HIT y ARR en el conjunto de centros evaluados
        </p>
        <div class="chart-container">
          <canvas id="chartProcesosHitArr"></canvas>
        </div>
      </article>

      <!-- Criterios procesos -->
      <article class="card">
        <h3>Criterios de procesos evaluados</h3>
        <p class="card-sub">
          Checklist unificada (Corner + Exclusivo). Se muestran primero los criterios comunes en el orden Corner.
        </p>
        <ul id="listaCriterios" class="criteria-list"></ul>
        <div class="criteria-footer">
          <small id="criteriaResumen"></small>
          <button class="criteria-btn" id="btnVerMasCriteria">Ver m√°s criterios</button>
        </div>
      </article>
    </section>

    <!-- NUEVO M√ìDULO: INFORME DE VISITA -->
    <section class="card" style="margin-top:16px;">
      <h3>Informe de visita</h3>
      <p class="card-sub">
        M√≥dulo demo para registrar el detalle de una visita y sus resultados. (Pendiente de conexi√≥n con datos reales.)
      </p>
      <div class="visit-layout">
        <!-- Columna izquierda -->
        <div>
          <div class="visit-meta-grid">
            <div class="visit-field">
              <span class="visit-label">Centro</span>
              <select class="visit-select">
                <option>Selecciona centro...</option>
                <option>Madrid ¬∑ Reina Mercedes</option>
                <option>Madrid ¬∑ Tetu√°n</option>
                <option>Sevilla ¬∑ Nervi√≥n</option>
                <option>Bilbao ¬∑ Gran V√≠a</option>
              </select>
            </div>
            <div class="visit-field">
              <span class="visit-label">Delegado</span>
              <select class="visit-select">
                <option>Selecciona delegado...</option>
                <option>Blanca</option>
                <option>Cecilia</option>
                <option>Daniel</option>
                <option>Eneritz</option>
                <option>Luis</option>
              </select>
            </div>
          </div>

          <div class="visit-meta-grid">
            <div class="visit-field">
              <span class="visit-label">Fecha visita</span>
              <input type="date" class="visit-input" />
            </div>
            <div class="visit-field">
              <span class="visit-label">Tipo visita</span>
              <select class="visit-select">
                <option>Regular</option>
                <option>Apertura</option>
                <option>Seguimiento</option>
                <option>Formaci√≥n</option>
              </select>
            </div>
          </div>

          <div class="visit-field">
            <span class="visit-label">% Procesos aplicados (demo)</span>
            <input type="text" class="visit-input" value="84%" />
          </div>
          <div class="visit-field">
            <span class="visit-label">% HIT / ARR (demo)</span>
            <input type="text" class="visit-input" value="81% / 68%" />
          </div>

          <div class="visit-field">
            <span class="visit-label">Etiquetas r√°pidas</span>
            <div class="visit-tags">
              <span class="visit-tag">‚úÖ Objetivos cumplidos</span>
              <span class="visit-tag">‚ö†Ô∏è Procesos mejorables</span>
              <span class="visit-tag">üìö Formaci√≥n realizada</span>
              <span class="visit-tag">üìù Plan de acci√≥n</span>
            </div>
          </div>
        </div>

        <!-- Columna derecha -->
        <div>
          <div class="visit-field">
            <span class="visit-label">Resumen de la visita</span>
            <textarea class="visit-textarea" placeholder="Descripci√≥n breve de los hitos de la visita, acuerdos, incidencias... (demo)"></textarea>
          </div>
          <div class="visit-field">
            <span class="visit-label">Plan de acci√≥n / pr√≥ximos pasos</span>
            <textarea class="visit-textarea" placeholder="Acciones acordadas, responsable y fechas objetivo (demo)"></textarea>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ------- GR√ÅFICOS (Chart.js) --------

    // 1. Evoluci√≥n mensual: barras + l√≠neas
    const ctxEvo = document.getElementById('chartEvolucion').getContext('2d');
    const chartEvolucion = new Chart(ctxEvo, {
      type: 'bar',
      data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets: [
          {
            type: 'bar',
            label: '% Procesos aplicados',
            data: [78, 80, 81, 82, 83, 84, 85, 86, 87, 88, 87, 88],
            backgroundColor: 'rgba(100,116,139,0.9)',
            borderRadius: 6
          },
          {
            type: 'line',
            label: '% HIT',
            data: [76, 77, 78, 79, 80, 81, 82, 83, 84, 83, 82, 82],
            borderColor: '#ef4444',
            borderWidth: 3,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          },
          {
            type: 'line',
            label: '% Conversi√≥n a prueba',
            data: [32, 33, 34, 35, 36, 37, 38, 39, 40, 40, 39, 40],
            borderColor: '#0ea5e9',
            borderWidth: 3,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          },
          {
            type: 'line',
            label: '% Conversi√≥n a venta',
            data: [21, 22, 23, 24, 25, 26, 27, 27, 28, 27, 26, 27],
            borderColor: '#a855f7',
            borderWidth: 3,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            align: 'center',
            labels: {
              usePointStyle: true,
              color: '#e5e7eb',
              font: { size: 11, weight: 'bold' }
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 0,
            suggestedMax: 100
          }
        }
      }
    });

    // 2. Estado de visitas
    const ctxVis = document.getElementById('chartVisitas').getContext('2d');
    const chartVisitas = new Chart(ctxVis, {
      type: 'doughnut',
      data: {
        labels: ['Realizadas', 'Pendientes', 'Anuladas'],
        datasets: [{
          data: [72, 19, 9],
          borderWidth: 0,
          backgroundColor: [
            'rgba(59,130,246,0.9)',
            'rgba(234,179,8,0.9)',
            'rgba(239,68,68,0.9)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#e5e7eb', font: { size: 11, weight: 'bold' } }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed}%`
            }
          }
        },
        cutout: '65%'
      }
    });

    // 3. √Årea de mejora de procesos
    const ctxArea = document.getElementById('chartAreaMejora').getContext('2d');
    const chartAreaMejora = new Chart(ctxArea, {
      type: 'bar',
      data: {
        labels: [
          'Seguimiento a 7 d√≠as',
          'Entrega folleto HIT',
          'Simulaci√≥n financiaci√≥n',
          'Registro motivo no venta',
          'Uso guion ACE',
          'Teleaudiometr√≠a',
          'Derivaci√≥n ORL',
          'Plan fidelizaci√≥n',
          'Registro competidor',
          'Revisi√≥n preventiva'
        ],
        datasets: [{
          label: '% procesos no aplicados',
          data: [38, 34, 31, 29, 27, 25, 22, 20, 18, 15],
          backgroundColor: 'rgba(239,68,68,0.9)',
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11, weight: 'bold' } }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.parsed.x}% no aplicado`
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 0,
            suggestedMax: 100
          },
          y: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { display: false }
          }
        }
      }
    });

    // 4. Ranking delegados
    const ctxDel = document.getElementById('chartDelegados').getContext('2d');
    const labelsDelegados = ['Blanca', 'Cecilia', 'Daniel', 'Eneritz', 'Luis'];
    const dataIndiceGlobal = [87, 92, 80, 85, 77];

    const chartDelegados = new Chart(ctxDel, {
      type: 'bar',
      data: {
        labels: labelsDelegados,
        datasets: [{
          label: '% √≠ndice global delegado',
          data: dataIndiceGlobal,
          backgroundColor: [
            'rgba(59,130,246,0.9)',
            'rgba(239,68,68,0.9)',
            'rgba(14,165,233,0.9)',
            'rgba(168,85,247,0.9)',
            'rgba(234,179,8,0.9)'
          ],
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11, weight: 'bold' } }
          },
          tooltip: {
            callbacks: { label: ctx => `${ctx.parsed.y}% ¬∑ √≠ndice global` }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 50,
            suggestedMax: 100
          }
        }
      }
    });

    // 5. Procesos, HIT y ARR
    const ctxPHA = document.getElementById('chartProcesosHitArr').getContext('2d');
    const chartProcesosHitArr = new Chart(ctxPHA, {
      type: 'bar',
      data: {
        labels: ['Procesos', 'HIT', 'ARR'],
        datasets: [{
          label: '% global',
          data: [84, 81, 68],
          backgroundColor: [
            'rgba(59,130,246,0.9)',
            'rgba(239,68,68,0.9)',
            'rgba(168,85,247,0.9)'
          ],
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11, weight: 'bold' } }
          },
          tooltip: {
            callbacks: { label: ctx => `${ctx.parsed.y}%` }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 50,
            suggestedMax: 100
          }
        }
      }
    });

    // --- Criterios de procesos (unificado Corner + Exclusivo, DEMO) ---
    const CRITERIOS_PROCESOS = [
      "Acogida al cliente con una sonrisa, amable y cercano",
      "Llamar al paciente por su nombre",
      "Acompa√±ar al paciente al gabinete para la revisi√≥n auditiva",
      "Ofrecer pasar a gabinete al acompa√±ante",
      "Confirmar motivo de visita",
      "Preguntar c√≥mo nos ha conocido",
      "Presentarnos por nombre, especialidad",
      "Presentar a la Compa√±√≠a, su expansi√≥n y calidad de equipos y producto",
      "Abrir ficha y Rellenar RGPD completa (incluido cheks condiciones comerciales)",
      "Realizar anamnesis HACE (H√°bitos, Antecedentes, Cl√≠nica, Expectativas)",
      "Explicar que realizamos un examen auditivo completo y en qu√© consiste",
      "Equipos previamente desinfectados",
      "Explicar brevemente cada prueba y asegurarnos que lo ha entendido",
      "Evaluar ambos o√≠dos con la videotoscopia",
      "Realizar timpanometr√≠a",
      "Realizar VA-VO-UCL",
      "Realizar logoaudiometr√≠a",
      "Resumir resultados y explicar con ayuda de gr√°ficas",
      "Vincular resultados con s√≠ntomas comentados en la anamnesis",
      "Simular sonidos para hacer visible la p√©rdida auditiva",
      "Explicar la prueba de capacidades auditivas (prueba HIT / ARR) como demo",
      "Disponer de stock de aud√≠fonos seg√∫n agenda y tr√°fico",
      "Escoger aud√≠fono seg√∫n perfil en gama recomendada",
      "Realizar programaci√≥n inicial y ajustes seg√∫n perfil",
      "Explicar manejo b√°sico de los aud√≠fonos al cliente",
      "Entregar documentaci√≥n (contrato, presupuesto, pasaporte)",
      "Registrar la prueba en el sistema (Gio)",
      "Explicar pol√≠tica comercial (segunda pareja, compromisos, etc.)",
      "Informar que se llamar√° al d√≠a siguiente para seguimiento",
      "Citar revisi√≥n a los 4 d√≠as",
      "Explicar qu√© anotar en el pasaporte (me molesta / estoy bien, etc.)",
      "Resaltar logros de expectativas y ajustes en cada visita",
      "Resolver objeciones",
      "Explicar facilidades de pago (Infinity, NextYear, etc.)",
      "Resumir compromisos y packs Serenidad / Serenidad + / HIT",
      "Recomendar igualar gama de segunda pareja",
      "Entregar kit de higiene y ense√±ar su uso",
      "Ofrecer ajustes en remoto a los 3 y 6 meses",
      "Revisi√≥n a 7 d√≠as tras la adaptaci√≥n",
      "Revisi√≥n al mes",
      "Revisi√≥n a los 3 meses",
      "Revisi√≥n cada 6/12 meses",
      "Control de satisfacci√≥n y NPS",
      "Registrar devoluciones y motivo",
      "Registrar derivaciones a ORL",
      "Registrar reubicaciones a otros centros",
      "Teleaudiometr√≠a activada y explicada",
      "Uso de recordatorios SMS / email para citas",
      "Plan de fidelizaci√≥n aplicado",
      "Registro de competidor mencionado por el cliente",
      "Criterio proceso demo 51",
      "Criterio proceso demo 52",
      "Criterio proceso demo 53",
      "Criterio proceso demo 54",
      "Criterio proceso demo 55",
      "Criterio proceso demo 56",
      "Criterio proceso demo 57",
      "Criterio proceso demo 58",
      "Criterio proceso demo 59",
      "Criterio proceso demo 60",
      "Criterio proceso demo 61",
      "Criterio proceso demo 62",
      "Criterio proceso demo 63",
      "Criterio proceso demo 64",
      "Criterio proceso demo 65",
      "Criterio proceso demo 66",
      "Criterio proceso demo 67",
      "Criterio proceso demo 68",
      "Criterio proceso demo 69",
      "Criterio proceso demo 70",
      "Criterio proceso demo 71",
      "Criterio proceso demo 72",
      "Criterio proceso demo 73",
      "Criterio proceso demo 74",
      "Criterio proceso demo 75",
      "Criterio proceso demo 76",
      "Criterio proceso demo 77",
      "Criterio proceso demo 78",
      "Criterio proceso demo 79",
      "Criterio proceso demo 80",
      "Criterio proceso demo 81",
      "Criterio proceso demo 82",
      "Criterio proceso demo 83",
      "Criterio proceso demo 84",
      "Criterio proceso demo 85",
      "Criterio proceso demo 86",
      "Criterio proceso demo 87",
      "Criterio proceso demo 88",
      "Criterio proceso demo 89",
      "Criterio proceso demo 90"
    ];

    const MAX_VISIBLE_CRITERIOS = 12;
    let criteriosExpandido = false;

    function renderCriterios() {
      const lista = document.getElementById('listaCriterios');
      const resumen = document.getElementById('criteriaResumen');
      const btn = document.getElementById('btnVerMasCriteria');

      lista.innerHTML = '';
      CRITERIOS_PROCESOS.forEach((crit, idx) => {
        const li = document.createElement('li');
        li.className = 'criteria-item';

        const idxSpan = document.createElement('span');
        idxSpan.className = 'criteria-index';
        idxSpan.textContent = idx + 1;

        const textSpan = document.createElement('span');
        textSpan.className = 'criteria-text';
        textSpan.textContent = crit;

        li.appendChild(idxSpan);
        li.appendChild(textSpan);
        lista.appendChild(li);
      });

      if (!criteriosExpandido) {
        lista.scrollTop = 0;
      }

      if (CRITERIOS_PROCESOS.length > MAX_VISIBLE_CRITERIOS) {
        if (!criteriosExpandido) {
          resumen.textContent = `Listado completo de ${CRITERIOS_PROCESOS.length} criterios (scroll para ver m√°s)`;
          btn.textContent = 'Expandir a altura completa';
          btn.style.display = 'inline-block';
          lista.style.maxHeight = '210px';
        } else {
          resumen.textContent = `Mostrando todos los ${CRITERIOS_PROCESOS.length} criterios (alto ampliado)`;
          btn.textContent = 'Volver a vista reducida';
          btn.style.display = 'inline-block';
          lista.style.maxHeight = 'none';
        }
      } else {
        resumen.textContent = `Mostrando todos los ${CRITERIOS_PROCESOS.length} criterios`;
        btn.style.display = 'none';
      }
    }

    document.getElementById('btnVerMasCriteria').addEventListener('click', () => {
      criteriosExpandido = !criteriosExpandido;
      renderCriterios();
    });

    // --- Toast helper ---
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => toast.remove(), 300);
      }, 1800);
    }

    const btnSaveView = document.getElementById('btnSaveView');
    const btnExportHtml = document.getElementById('btnExportHtml');
    const btnSyncCloud = document.getElementById('btnSyncCloud');
    const btnToggleTheme = document.getElementById('btnToggleTheme');
    const btnPrint = document.getElementById('btnPrint');
    const selectCentro = document.getElementById('selectCentro');
    const selectDelegado = document.getElementById('selectDelegado');
    const resumenSub = document.getElementById('resumenSub');

    const CONFIG_KEY = 'gestionarAudioConfig';

    function textoCentro(value) {
      const opt = selectCentro.querySelector(`option[value="${value}"]`);
      return opt ? opt.textContent : 'Centro: Todos';
    }

    function textoDelegado(value) {
      const opt = selectDelegado.querySelector(`option[value="${value}"]`);
      return opt ? opt.textContent : 'Delegado: Todos';
    }

    function actualizarTextoResumen() {
      const centroText = textoCentro(selectCentro.value);
      const delegadoText = textoDelegado.select
        ? textoDelegado(selectDelegado.value)
        : textoDelegado(selectDelegado.value);

      resumenSub.textContent =
        'Visi√≥n r√°pida de procesos, HIT, primeros auxilios, conversiones y formaciones ¬∑ ' +
        centroText + ' ¬∑ ' + delegadoText + ' (datos demo)';
    }

    function applyTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-theme');
        btnToggleTheme.innerHTML = '<span class="icon">üåô</span> Modo oscuro';
      } else {
        document.body.classList.remove('light-theme');
        btnToggleTheme.innerHTML = '<span class="icon">‚òÄÔ∏è</span> Modo claro';
      }
    }

    function saveConfig() {
      const cfg = {
        theme: document.body.classList.contains('light-theme') ? 'light' : 'dark',
        centro: selectCentro.value,
        delegado: selectDelegado.value
      };
      try {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
      } catch (e) {
        console.warn('No se pudo guardar la configuraci√≥n', e);
      }
    }

    function loadConfig() {
      let cfg = null;
      try {
        const raw = localStorage.getItem(CONFIG_KEY);
        if (raw) cfg = JSON.parse(raw);
      } catch (e) {
        console.warn('No se pudo leer la configuraci√≥n', e);
      }

      if (cfg) {
        if (cfg.theme) applyTheme(cfg.theme);
        if (cfg.centro) selectCentro.value = cfg.centro;
        if (cfg.delegado) selectDelegado.value = cfg.delegado;
      } else {
        applyTheme('dark');
      }

      actualizarTextoResumen();
      actualizarEstadosKpi();
      renderCriterios();
    }

    // Clasificaci√≥n KPIs
    function actualizarEstadosKpi() {
      const kpiPills = document.querySelectorAll('.kpi-pill');
      kpiPills.forEach(pill => {
        const type = pill.getAttribute('data-kpi-type');
        const valueEl = pill.querySelector('.kpi-value');
        const statusWrapper = pill.querySelector('.kpi-status');
        const iconEl = statusWrapper.querySelector('.kpi-status-icon');
        if (!valueEl || !statusWrapper || !iconEl) return;

        const raw = valueEl.textContent.trim().replace('%', '');
        const value = parseFloat(raw);
        if (isNaN(value)) return;

        let estado = 'mejorable';
        let texto = 'Mejorable';
        let icon = 'üî¥';

        if (type === 'conversion') {
          if (value >= 80) {
            estado = 'optimo';
            texto = '√ìptimo';
            icon = 'üü¢';
          } else {
            estado = 'mejorable';
            texto = 'Mejorable';
            icon = 'üî¥';
          }
        } else {
          if (value >= 100) {
            estado = 'optimo';
            texto = '√ìptimo';
            icon = 'üü¢';
          } else if (value >= 85) {
            estado = 'muybien';
            texto = 'Muy bien';
            icon = 'üü°';
          } else {
            estado = 'mejorable';
            texto = 'Mejorable';
            icon = 'üî¥';
          }
        }

        statusWrapper.classList.remove('optimo', 'muybien', 'mejorable');
        statusWrapper.classList.add(estado);
        statusWrapper.title = texto + ' ¬∑ dato demo';
        iconEl.textContent = icon;
      });
    }

    // Bot√≥n tema claro/oscuro
    btnToggleTheme.addEventListener('click', () => {
      const isLight = !document.body.classList.contains('light-theme');
      applyTheme(isLight ? 'light' : 'dark');
      saveConfig();
    });

    // Guardar vista
    btnSaveView.addEventListener('click', () => {
      saveConfig();
      showToast('Preferencias guardadas en este navegador');
    });

    // Imprimir
    btnPrint.addEventListener('click', () => {
      window.print();
    });

    // Exportar HTML
    btnExportHtml.addEventListener('click', () => {
      try {
        const htmlCompleto = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
        const blob = new Blob([htmlCompleto], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gestion-audio-dashboard-general.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('HTML exportado (descarga iniciada)');
      } catch (e) {
        console.error('Error exportando HTML', e);
        showToast('No se pudo exportar el HTML');
      }
    });

    // Actualizar nube (demo)
    btnSyncCloud.addEventListener('click', () => {
      showToast('Sincronizaci√≥n con la nube simulada (demo)');
    });

    selectCentro.addEventListener('change', () => {
      actualizarTextoResumen();
      saveConfig();
    });

    selectDelegado.addEventListener('change', () => {
      actualizarTextoResumen();
      saveConfig();
    });

    // Init
    loadConfig();
  </script>
</body>
</html>
